---
title: "Prelim Analysis/Data Inspection"
author: "Daniel Shephard, Jake Bowers, Michael DiDomenico"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---


This file executes the analysis of the experiment. It relies on files produced by the `datasetup.Rmd` file.

```{r}
library(lmtest)
library(sandwich)
library(car)
```

These two are produced by the `datasetup.Rmd` file.

```{r}
load("Data/or.df.TOTAL.rda")
load("Data/monthlyordat.rda")
```


```{r Welcomes_by_Office, echo=FALSE}

#Create a table showing the number of observations by month for each office
offices <- c(unique(or.df.TOTAL$'277.Field.Office'))[1:14]
months <- c('mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep')
desc.table.1 <- matrix(nrow = 14, ncol = 7,
		       dimnames = list(offices, months))

#Add the counts of welcomes for March
for(i in 1:14)
{
	desc.table.1[i, 1] <- length(which(or.df1$`277.Field.Office`==offices[i]))
}

#Add the counts of welcomes for April
for(i in 1:14)
{
	desc.table.1[i, 2] <- length(which(or.df2$`277.Field.Office`==offices[i]))
}

#Add the counts of welcomes for May
for(i in 1:14)
{
	desc.table.1[i, 3] <- length(which(or.df3$`277.Field.Office`==offices[i]))
}

#Add the counts of welcomes for June
for(i in 1:14)
{
	desc.table.1[i, 4] <- length(which(or.df4$`277.Field.Office`==offices[i]))
}

#Add the counts of welcomes for July
for(i in 1:14)
{
	desc.table.1[i, 5] <- length(which(or.df5$`277.Field.Office`==offices[i]))
}

#Add the counts of welcomes for August
for(i in 1:14)
{
	desc.table.1[i, 6] <- length(which(or.df6$`277.Field.Office`==offices[i]))
}

#Add the counts of welcomes for September
for(i in 1:14)
{
	desc.table.1[i, 7] <- length(which(or.df7$`277.Field.Office`==offices[i]))
}

```

## Table of welcome conversations by field office

The following table shows the number of welcome conversations conducted at each of the field offices in each month. The first column has the field office labels.

```{r}
knitr::kable(desc.table.1)
```


# Pair Offices

Pairs were created by both urban, geography, size (number of people who came
for UI), and quality of staff (judgement of the management in Oregon). Pairs
provided by the management of the Oregon State program.

```{r Pull_Pairs}
#----ORIGINAL CODE FOR RANDOMIZATION------
##pairfilepath <- "C:/Users/DanielDShephard/Documents/SBST/DOL/UI Oregon/Analysis/OR_Analysis/Oregon_Pairs_14-Field-Offices_20160111.csv" 
pairfilepath <- "Data/Oregon_Pairs_14-Field-Offices_20160111.csv" 
pairs2 <- read.csv(pairfilepath, row.names = 1)
row.names(pairs2)<-pairs2$fo.num
pairs2 <- pairs2[order(pairs2$pair), ] #ensure that all pairs are next to each other
#Random generation of uniform distribution x14, one number per field office
#The highest number in the pair is allocated to the treatment group
pairs2$treat <- 0
set.seed(20160108) #note, ran once with 20150108, but changed to match date
ran.no <- runif(14)
for (i in 1:7)
{
	if(ran.no[i*2] > ran.no[(i*2)-1])
	{
		pairs2[i*2, "treat"] <- 1
	}
	else
	{
		pairs2[i*2-1, "treat"] <- 1
	}

}

#Check the frequency of assignment with different seeds to ensure 50% chance
#Run allocation logic used above through 1000 different seeds
pair2 <- NA
pair2 <- as.numeric(pair2)
for (q in 1:1000) #run 1000 simulations of different seeds
{
	set.seed(20160107+q)
	ran.no <- runif(14)
	for (i in 1:7) #for a set of 7 pairs with the current seed do the following
	{
		if(ran.no[i*2] > ran.no[(i*2)-1]) #if the even number in the pair is greater than the odd number
		{
			pair2 <- rbind(pair2, 1) #then give it a treatment value of 1
		}
		else
		{
			pair2 <- rbind(pair2, 0) #else give the second in the pair a value of 0
		}
	}
}
treat.probability <- mean(pair2, na.rm=TRUE)
samp.m1 <- (lm(ui.wks ~ treat, data=pairs2)) #original scores
samp.m2 <- (lm(tot ~ treat, data=pairs2)) #original scores
summary(samp.m1)
summary(samp.m2)
#Write out the new dataset with treatment allocation
#The number of welcomes and average weeks on UI is from 2015 data (Pre Intervention)
knitr::kable(pairs2[order(pairs2$pair, pairs2$treat), c(1:2, 14, 9, 12, 10)]) #Order by pairs, with control pair office first

```

**Outcomes**


```{r}
outcomes <- c("welcome","uiexit","employed","time.to.exit","plans","wages")
summary(or.df.TOTAL[,outcomes])
aggvars <- c("insert",outcomes)
```

## Employment Center Level analysis


```{r}
## This next creates more columns than I would like
library(dplyr)
officedat <- or.df.TOTAL %>% group_by(fo.num) %>% summarize_at(aggvars,.funs=funs(mean(.,na.rm=TRUE),sum(is.na(.)),n()))
officedf <- as.data.frame(officedat[,c("fo.num",grep("mean",names(officedat),value=TRUE),"wages_sum","insert_n")])
row.names(officedf)<-officedf$fo.num
names(officedf)[names(officedf)==c("wages_sum","insert_n")] <- c("missingwage","N")
```

Add treatment assignment info

```{r}
officedf$fo.num <- as.numeric(officedf$fo.num)
wrkdat <- inner_join(officedf,pairs2,by="fo.num")
wrkdat <- wrkdat[order(wrkdat$pair,wrkdat$treat),]
```

Pair-mean center to handle the pairing:

```{r}

wrkdat$treatMD <- with(wrkdat,treat - ave(treat,pair))
for(i in outcomes){
	message(i)
	nm <- paste(i,"_mean",sep="")
	wrkdat[,paste(i,"MD",sep="")]<- wrkdat[[nm]] - ave(wrkdat[[nm]],wrkdat$pair)
}


```

# Office Level Effects

```{r}
## First, just show two equivalent ways to get the ITT
welcomeATEa <- lm(welcome_mean~treat+pair,data=wrkdat)
welcomeATE <- lm(welcomeMD~treatMD,data=wrkdat)
stopifnot(all.equal(coef(welcomeATEa)[[2]],coef(welcomeATE)[[2]]))

## Next calc the diff of means for all outcomes
aggoutcomes <- paste(outcomes,"MD",sep="")
theITTS <- sapply(aggoutcomes,function(v){
			  coef(lm(reformulate("treatMD",response=v),data=wrkdat))[[2]]
})
theITTS
```

Now test the hypothesis of no effects. Because the sample size is so small, we use a randomization-based approach.

```{r}
## The coin package allows us to use permutations/repetitions of the experiment to assess the hypothesis of no effects in a block-randomized experiment
library(coin)
wrkdat$treatF <- factor(wrkdat$treat,levels=c("1","0"))
welcomeTest <- oneway_test(welcome_mean ~ treatF | pair, data=wrkdat, distribution=approximate(B=1000))
welcomeTest

## The following uses a large sample approximation to the randomization distribution (Mostly just a check on the preceding)
library(RItools)
xb1<-xBalance(treat ~ welcome_mean,strata=list(pair=~pair),data=wrkdat,report="all")
xb1$results

## Now do it for all
theps <- sapply(aggoutcomes,function(v){
			 results <- oneway_test(reformulate("treatF | pair ",response=v),data=wrkdat,distribution=approximate(B=1000))
			 return(pvalue(results))
})
theps
```

Some results

```{r}
cbind(theITTS,theps)
```

